# LIPS Scraping Design（Octoparse）

## 1. 目的
LIPS の最新投稿一覧から複数投稿を安定的に収集し、  
**投稿詳細 → ユーザープロフィール → SNSリンク抽出** までを一連で自動化する。

本設計では以下を明確な方針とする。

- SNS 未登録・非公開など **HTML に存在しない要素は「欠損（空欄）が正」**
- 誤取得（公式アカウント・共通フッター等）を最優先で回避
- 単発取得ではなく **運用前提（重複・取りこぼし耐性）** の設計

---

## 2. 対象ページ構成
- 最新投稿一覧  
  https://lipscosme.com/posts?sort=latest

- 投稿詳細ページ  
  https://lipscosme.com/posts/{post_id}

- ユーザープロフィールページ  
  https://lipscosme.com/users/n/@{username}

---

## 3. 全体フロー（論理設計）

最新投稿一覧（最大10ページ）
↓ Loop（投稿カード単位）
投稿詳細ページ
├ 投稿日時取得
├ 投稿URL取得
└ ユーザーURL取得
↓
ユーザープロフィールページ
├ Instagram
├ X（Twitter）
├ YouTube
├ TikTok
└ Webサイト（存在する場合のみ）

yaml
コードをコピーする

---

## 4. Octoparse設計方針

### 4.1 Loop設計（投稿カード）
- **Loop Item**：一覧ページ上の投稿カード1件
- 1ページあたり約20件を想定
- Loop 内で「詳細 → プロフィール」まで完結させる

#### 処理順
1. 投稿カードを Loop
2. 投稿詳細ページへ遷移
3. 投稿情報取得
4. ユーザープロフィールへ遷移
5. SNSリンク取得
6. 次の投稿へ

---

### 4.2 ページ遷移方式
- 基本：**クリック遷移**
- 認識が不安定な場合：URL遷移に切替

**理由**  
LIPS は動的描画があり、  
URL 遷移のみ／クリックのみでは要素認識が落ちるケースがあるため、  
**状況に応じて使い分ける前提設計**とする。

---

### 4.3 Pagination設計（最大10ページ）
- Next ボタンが安定している場合  
  - Octoparse の Pagination 機能を使用
- 不安定な場合  
  - URL ルールが成立する場合は URL リスト方式
- どちらも不可の場合  
  - クリック + 明示的 Delay + 実行結果確認で運用

※ 無制限取得は行わず、  
**最大10ページで制御**（重複・取得負荷・運用安定性を優先）

---

## 5. 取得項目設計

### 5.1 投稿詳細ページ

| Field | 内容 | 備考 |
|---|---|---|
| post_url | 投稿URL | Octoparse の URL 取得 |
| published_at | 投稿日時 | 動的描画のため Delay 必須 |
| user_url | ユーザーURL | プロフィール遷移用 |

※ 投稿日時は **一覧ページの表示日付ではなく、投稿詳細ページを正**とする。

---

### 5.2 プロフィールページ（SNS）

※ **取得範囲をプロフィール領域に限定**  
（ヘッダー／フッター／公式アカウント誤取得防止）

| Field | 取得条件 | 判定ルール |
|---|---|---|
| instagram_url | instagram.com を含む a タグ | 存在しなければ空欄 |
| x_url | x.com / twitter.com | 同上 |
| youtube_url | youtube.com | ボタンのみで URL が無い場合は空欄 |
| tiktok_url | tiktok.com | 同上 |
| website_url | SNS 以外の外部リンク | HTML に URL が無ければ空欄が正 |

---

## 6. 待機（Delay）設計

### 投稿詳細ページ
- ページ遷移後：**1500〜3000ms**

### プロフィールページ
- SNS リンク描画完了まで：**2000〜4000ms**

**設計理由**
- 同一 URL でも読み込みタイミングにより要素認識が失敗するため
- Delay を「保険」ではなく **仕様として明示**

---

## 7. 重複・欠損の扱い

### 欠損
- SNS 未登録・非公開の場合  
  → **空欄が正（NULL 相当）**

### 重複
- `post_url` をユニークキーとして運用
- 後段（スプレッドシート / DB）での重複排除を前提とした設計

---

## 8. 既知の問題と回避策

### 問題①
一覧 → 詳細遷移後、要素認識が不安定になる

**対策**
- クリック / URL 遷移の切替
- Delay 調整
- XPath の範囲再指定

---

### 問題②
「Webサイト」ボタンがあるが URL が取得できない

**対策**
- HTML に URL が存在しないケースあり
- 無理に埋めず **空欄を正とする**

---

## 9. 出力データ形式（例）

post_url,
published_at,
user_url,
instagram_url,
x_url,
youtube_url,
tiktok_url,
website_url

yaml
コードをコピーする

---

## 10. 補足
本設計は **「取れること」より「誤らないこと」を優先**している。  
取得率を無理に上げる設計は行わず、  
後工程（分析・連携）で安心して扱えるデータ構造を重視した。
